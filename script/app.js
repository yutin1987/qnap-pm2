var Album,AlbumList,_ref,_ref1,__hasProp={}.hasOwnProperty,__extends=function(e,t){function n(){this.constructor=e}for(var o in t)__hasProp.call(t,o)&&(e[o]=t[o]);return n.prototype=t.prototype,e.prototype=new n,e.__super__=t.prototype,e};Album=function(e){function t(){return _ref=t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.count=0,t.prototype.initialize=function(e){return this.list=new PhotoList([],{api:API.PHOTO_LIST+"&a="+e.id,album:!0})},t}(Backbone.Model),AlbumList=function(e){function t(){return _ref1=t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.model=Album,t.prototype.page=0,t.prototype.page_count=100,t.prototype.watch=null,t.prototype.data={},t.prototype.initialize=function(e){return null==e&&(e={}),this.data=e},t.prototype.reload=function(){return null!=this.watch&&clearTimeout(this.watch),this.page=0,this.reset(),this.req()},t.prototype.req=function(e){var t=this;return null==e&&(e=0),this.data.p=this.page+1,$.req(API.ALBUM_LIST,this.data,function(e){var n;return n=$("DataList FileItem",e),!n.length||($(n).each(function(e,n){return t.add(album2data(n))}),t.page+=1,n.length<t.page_count)?void 0:t.watch=setTimeout(function(){return t.req()},1e3)},function(){return console.log("error"),5>e&&(e+=1),t.watch=setTimeout(function(){return t.req(e)},e)})},t}(Backbone.Collection);var Photo,PhotoList,_ref,_ref1,__hasProp={}.hasOwnProperty,__extends=function(e,t){function n(){this.constructor=e}for(var o in t)__hasProp.call(t,o)&&(e[o]=t[o]);return n.prototype=t.prototype,e.prototype=new n,e.__super__=t.prototype,e};Photo=function(e){function t(){return _ref=t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t}(Backbone.Model),PhotoList=function(e){function t(){return _ref1=t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.model=Photo,t.prototype.api=null,t.prototype.album=!1,t.prototype.lock=!1,t.prototype.page=0,t.prototype.pageCount=100,t.prototype.count=0,t.prototype.initialize=function(e,t){return null!=(null!=t?t.api:void 0)&&this.linkTo(t.api),null!=(null!=t?t.album:void 0)?this.album=!0:void 0},t.prototype.req=function(){var e=this;if(null!=this.api&&this.lock===!1)return this.lock=!0,$.req(this.api,{p:this.page+1,s:"timeline",sd:"desc"},function(t){var n;return e.count=parseInt($("photoCount",t).text()),n=$("DataList FileItem",t),!n.length||($(n).each(function(t,n){return e.add(photo2data(n))}),e.page+=1,n.length<e.pageCount)?void 0:e.lock=!1},function(){return e.lock=!1})},t.prototype.reload=function(){return this.page=0,this.count=0,this.lock=!1,this.reset(),this.req()},t.prototype.linkTo=function(e){return this.api=e},t}(Backbone.Collection);var User,_ref,__hasProp={}.hasOwnProperty,__extends=function(e,t){function n(){this.constructor=e}for(var o in t)__hasProp.call(t,o)&&(e[o]=t[o]);return n.prototype=t.prototype,e.prototype=new n,e.__super__=t.prototype,e};User=function(e){function t(){return _ref=t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.defaults={admin:!1,sid:null,usr:null,pwd:null},t.prototype.initialize=function(){var e;return this.set({usr:$.cookies.get("pmusr"),pwd:$.cookies.get("pmpwd")}),e={expiresAt:new Date((new Date).getTime()+2592e6)},this.on("change",function(){var t,n,o,r;o=this.changed,r=[];for(t in o)switch(n=o[t],t){case"usr":r.push($.cookies.set("pmusr",n,e));break;case"pwd":r.push($.cookies.set("pmpwd",n,e));break;default:r.push(void 0)}return r})},t.prototype.login=function(e,t,n){var o=this;return $.req(API.USER,{a:"login",u:e,p:Base64.encode(t)},function(e,t){var r;return console.log(e),console.log(t),console.log($("is_admin",e).text()),r={admin:$("is_admin",e).text()?!0:!1,sid:e.sid},o.set(r),1===t?"function"==typeof n?n(r,{code:1}):void 0:"function"==typeof n?n(r,{code:0,msg:"failed"}):void 0},function(){return"function"==typeof n?n({},{code:-1,msg:"offline"}):void 0})},t.prototype.logout=function(){var e=this;return this.set({usr:"",pwd:""}),$.req(API.USER,{a:"logout"},function(t,n){var o;return o={admin:!1,sid:null},e.set(o),1===n?"function"==typeof back?back({code:1}):void 0:"function"==typeof back?back({code:0,msg:"failed"}):void 0},function(){return"function"==typeof back?back({code:-1,msg:"offline"}):void 0})},t}(Backbone.Model),$(function(){var e,t,n,o,r,i,a,s,l,u,c,p,d,f,h,v,m,g,_,C,b,y,w,k,P;return r=$("body"),p=$("#navbar"),h=$("#viewport"),c=$("#menu"),l=$("#login"),u=$("#mask"),s=$("#loading"),a=$(".line",h),o=$(".album",h),f=$(".private",h),d=$(".photo",h),i=$(".full",h),n=document.documentElement.hasOwnProperty("ontouchstart")?"touchend":"click",$.focus=null,$.full={index:0,album:null},k=null,$.conf={line:{},photo:{}},t={album:[],"private":[]},y={init:"status-init",login:"status-login",viewport:"status-viewport",menu:"status-menu",overview:"status-overview",about:"status-about"},$.line=new PhotoList([],{api:API.LINE}),$.album=new AlbumList,$["private"]=new AlbumList({h:1}),$.search=new PhotoList,$.user=new User,P=$(window).width(),m=1024>=P?1:0,_=function(e){var t,n,o,r,i;return o=PATH+API.THUMB+"?f="+e.get("id")+"&s="+m,r='<div class="thumb" style="background-image: url('+o+')" />',t='<div class="img"><img src="'+o+'" /></div>',n='<div class="size">'+e.get("width")+"x"+e.get("height")+"</div>",i='<div class="time">'+new Date(e.get("time")).toFormat("yyyy-MM-dd")+"</div>",'<div class="item type-'+e.get("type")+'">'+r+t+n+i+"</div>"},e=function(e){var t,n,o,r,i,a,s;return r=PATH+API.THUMB+"?f="+e.get("cover")+"&s="+m,i='<div class="thumb" style="background-image: url('+r+')" />',t='<div class="img"><img src="'+r+'" /></div>',s='<div class="title">'+e.get("title")+"</div>",a='<div class="time">'+new Date(e.get("time")).toFormat("yyyy-MM-dd")+"</div>",n='<div class="length">'+e.list.length+"</div>",o='<div class="personal" />','<div class="item">'+i+t+s+a+n+o+"</div>"},w=function(){var e;return null!=(e=$.focus)&&e.req(),setTimeout(w,SYNC_INTERVAL)},w(),$.album.on("add",function(n){var o;return o=$(e(n)),o.data("key",n.id),t.album.push($('<div class="wrap" />').append(o))}),$.album.on("reset",function(){return t.album=[],o.empty()}),$["private"].on("add",function(n){var o;return o=$(e(n)),o.data("key",n.id),t["private"].push($('<div class="wrap" />').append(o))}),$["private"].on("reset",function(){return t["private"]=[],f.empty()}),$("#version").text(VERSION),$("#username").val($.user.get("usr")||""),$("#password").val($.user.get("pwd")||""),$.user.get("usr")&&$(".remember",l).addClass("checked"),C=function(){return $.conf.line={index:0,page:1,temp_v:null,temp_h:null},$.conf.album={index:0,page:1},$.conf.photo={index:0,page:1},$.line.reload(),$(".wrap",a).remove(),$.album.reload(),$["private"].reload(),$.focus=$.line},$.req(API.USER,{a:"login"},function(e,t){return 1===t?(r.removeClass(y.init),r.removeClass(y.login),r.addClass(y.viewport),C()):(r.removeClass(y.init),r.addClass(y.login))},function(){return r.removeClass(y.init),r.addClass(y.login)}),v=function(e,t,n){return r.addClass(y.init),$.user.login(e,t,function(o,i){switch(r.removeClass(y.init),l.removeClass("login-error"),i.code){case 0:return $.user.set({usr:"",pwd:""}),l.addClass("login-error");case 1:if(r.removeClass(y.login),r.addClass(y.viewport),n&&$.user.set({usr:e,pwd:t}),null==k||k!==e)return C();break;case-1:return r.addClass(y.init),v(e,t)}})},$("#login-submit",l).on(n,function(){var e,t,n;return n=$("#username").val(),e=$("#password").val(),t=$(".remember",l).hasClass("checked"),v(n,e,t)}),$("#login .remember").on(n,function(){return $(this).toggleClass("checked")}),$(".goto-line, .goto-album, .goto-private, .goto-logout, .goto-about",c).on("click",function(){return r.removeClass(y.menu),r.removeClass(y.about),$.focus=null}),$("#menu-toggle").on("touchstart",function(e){return e.preventDefault(),$(this).addClass("hover")}),$("#menu-toggle").on(n,function(e){return e.preventDefault(),$(this).removeClass("hover"),r.toggleClass(y.menu)}),$(".goto-line",c).on("click",function(){return $.focus=$.line,h.attr("class","show-line")}),$(".goto-album",c).on("click",function(){return h.attr("class","show-album")}),$(".goto-private",c).on("click",function(){return h.attr("class","show-private")}),$(".goto-logout",c).on("click",function(){return $.user.logout(),r.addClass(y.login)}),$(".goto-about",c).on("click",function(){return r.addClass(y.about)}),$("#mask").on("click",function(){return r.removeClass(y.about),r.removeClass(y.menu)}),b=function(e){var t;return r.addClass(y.overview),h.addClass("show-full"),$(".item",i).remove(),t=$('<div class="item">                <div class="thumb" style="background-image: url('+PATH+API.THUMB+"?f="+e+"&s="+m+')"></div>                <div class="original" style="background-image: url('+PATH+API.PHOTO+"?f="+e+')"></div>                <img class="listen thumb-listen" src="'+PATH+API.THUMB+"?f="+e+"&s="+m+'" />                <img class="listen original-listen" src="'+PATH+API.PHOTO+"?f="+e+'" />            </div>'),$(".thumb-listen",t).on("load",function(){return $(this).parent().addClass("thumb-loaded")}),$(".original-listen",t).on("load",function(){return $(this).parent().addClass("original-loaded")}),i.append(t),window.scrollTo(0,1)},$(".prev, .next",i).on("touchstart",function(e){return e.preventDefault(),$(this).addClass("hover")}),$(".prev, .next",i).on(n,function(e){if(e.preventDefault(),$(this).removeClass("hover"),null!=$.full.album){if($(this).hasClass("prev")){if(!($.full.index>1))return;$.full.index--}else{if(!$(this).hasClass("next"))return;if(!($.full.index<$.full.album.length-1))return;$.full.index++}return b($.full.album.at($.full.index).id)}}),a.on("click",".item",function(){var e,t;return e=$(this).data("key"),t=$.line.get(e),$.full.index=$.line.indexOf(t),$.full.album=$.line,b(t.id)}),$(".prev, .next",a).on("touchstart",function(e){return e.preventDefault(),$(this).addClass("hover")}),$(".prev, .next",a).on(n,function(e){if(e.preventDefault(),$(this).removeClass("hover"),$(this).hasClass("prev")){if(!($.conf.line.page>1))return;$.conf.line.page--}else{if(!$(this).hasClass("next"))return;if(!($.conf.line.page<Math.ceil($.line.length/PAGE_COUNT)))return;$.conf.line.page++}return $(p).addClass("loading"),$(s).text("Page "+$.conf.line.page+" / "+Math.ceil($.line.length/PAGE_COUNT)),setTimeout(function(){return $(p).removeClass("loading")},3*SYNC_INTERVAL),$(".wrap",a).remove(),$.conf.line.index=($.conf.line.page-1)*PAGE_COUNT}),o.on("click",".item",function(){var e;return e=$(this).data("key"),$.conf.photo.index=0,$.conf.photo.page=1,$.focus=$.album.get(e).list,$(".wrap",d).remove(),h.addClass("show-photo")}),f.on("click",".item",function(){var e;return e=$(this).data("key"),$.conf.photo.index=0,$.conf.photo.page=1,$.focus=$["private"].get(e).list,$(".wrap",d).remove(),h.addClass("show-photo")}),$(".back",d).on("touchstart",function(e){return e.preventDefault(),$(this).addClass("hover")}),$(".back",d).on(n,function(e){return e.preventDefault(),$(this).removeClass("hover"),$.focus=null,h.removeClass("show-photo")}),$(".prev, .next",d).on("touchstart",function(e){return e.preventDefault(),$(this).addClass("hover")}),$(".prev, .next",d).on(n,function(e){var t;if(e.preventDefault(),$(this).removeClass("hover"),null!=(null!=(t=$.focus)?t.album:void 0)){if($(this).hasClass("prev")){if(!($.conf.photo.page>1))return;$.conf.photo.page--}else{if(!$(this).hasClass("next"))return;if(!($.conf.photo.page<Math.ceil($.focus.length/PAGE_COUNT)))return;$.conf.photo.page++}return $(p).addClass("loading"),$(s).text("Page "+$.conf.photo.page+" / "+Math.ceil($.focus.length/PAGE_COUNT)),setTimeout(function(){return $(p).removeClass("loading")},3*SYNC_INTERVAL),$(".wrap",d).remove(),$.conf.photo.index=($.conf.photo.page-1)*PAGE_COUNT}}),d.on("click",".item",function(){var e,t;if(null!=$.focus)return e=$(this).data("key"),t=$.focus.get(e),$.full.index=$.focus.indexOf(t),$.full.album=$.focus,b(t.id)}),$(".back",i).on("touchstart",function(e){return e.preventDefault(),$(this).addClass("hover")}),$(".back",i).on(n,function(e){return e.preventDefault(),$(this).removeClass("hover"),h.removeClass("show-full"),r.removeClass(y.overview)}),g=function(){var e,n,r,i,s,l,u,c,p,h,v;for(t["private"].length>0&&(f.append(t["private"]),t["private"]=[]),t.album.length>0&&(o.append(t.album),t.album=[]),1>window.scrollY&&window.scrollTo(0,1),i=[],s=$.line.length<$.conf.line.page*PAGE_COUNT?$.line.length:$.conf.line.page*PAGE_COUNT;s>$.conf.line.index;)l=$.line.at($.conf.line.index++),r=$(_(l)),h=parseInt(l.get("width")),n=parseInt(l.get("height")),p=h/n,$(".img img",r).on("load",function(){return $(this).parent().parent().addClass("loaded")}),p>1.33?(r.addClass("lo-horizontal"),null!=$.conf.line.temp_h?($.conf.line.temp_h.append(r),$.conf.line.temp_h=null):($.conf.line.temp_h=$('<div class="wrap" />').append(r),i.push($.conf.line.temp_h))):p>.75?(r.addClass("lo-filled"),i.push($('<div class="wrap" />').append(r))):(r.addClass("lo-vertical"),null!=$.conf.line.temp_v?($.conf.line.temp_v.append(r),$.conf.line.temp_v=null):($.conf.line.temp_v=$('<div class="wrap" />').append(r),i.push($.conf.line.temp_v))),r.data("key",l.id);if(a.append(i),(null!=(v=$.focus)?v.album:void 0)===!0){for(e=$.focus,u=[],c=e.length<$.conf.photo.page*PAGE_COUNT?e.length:$.conf.photo.page*PAGE_COUNT;c>$.conf.photo.index&&(l=e.at($.conf.photo.index++),r=$(_(l)),r.data("key",l.id),u.push($('<div class="wrap" />').append(r)),0!==$.conf.photo.index%10););d.append(u)}return setTimeout(g,1.2*SYNC_INTERVAL)},g()});